@using System.Security.Claims
@inject IHttpContextAccessor HttpContextAccessor
@using DirtyCoins.Data
@inject ApplicationDbContext _context
@using DirtyCoins.Helpers

@{
    var cartJson = HttpContextAccessor.HttpContext.Request.Cookies["cart"];
    var cart = string.IsNullOrEmpty(cartJson)
        ? new List<DirtyCoins.Controllers.CartController.CartItem>()
        : Newtonsoft.Json.JsonConvert.DeserializeObject<List<DirtyCoins.Controllers.CartController.CartItem>>(cartJson);

    var cartCount = cart?.Sum(c => c.Quantity) ?? 0;
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - DirtyCoins</title>

    <!-- Bootstrap & Icons -->
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&family=Bebas+Neue&display=swap" rel="stylesheet">

    <!-- DirtyCoins Custom Theme -->
    <link rel="stylesheet" href="~/css/site-dirtycoins.css" />

    <link rel="icon" type="image/png" href="/images/aboutUs/favicon.png" />
</head>

<body>
    <!-- HEADER -->
    <header id="mainHeader">
        @await Html.PartialAsync("_Navbar")
    </header>

    <!-- BODY -->
    <main role="main" class="container-fluid px-0 dirtycoins-body">
        @RenderBody()
    </main>

    <!-- FOOTER -->
    <footer class="dc-footer">
        <div class="container py-5">
            <div class="row text-center text-md-start g-4">
                <div class="col-md-3">
                    <h5>DirtyCoins</h5>
                    <p>Thương hiệu thời trang đường phố mang tinh thần tự do, cá tính và khác biệt.</p>
                </div>
                <div class="col-md-3">
                    <h5>Liên hệ</h5>
                    <a href="mailto:support@dirtycoins.vn"><i class="bi bi-envelope me-1"></i> support@dirtycoins.vn</a>
                    <a href="tel:+84901234567"><i class="bi bi-telephone me-1"></i> 0901 234 567</a>
                    <a href="#"><i class="bi bi-geo-alt me-1"></i> 69 Nguyễn Huệ, Q.1, TP.HCM</a>
                </div>
                <div class="col-md-3">
                    <h5>Chính sách</h5>
                    <a href="/Home/Privacy">Bảo mật</a>
                    <a href="/Home/Contact">Liên hệ</a>
                </div>
                <div class="col-md-3">
                    <h5>Kết nối</h5>
                    <div class="d-flex justify-content-center justify-content-md-start gap-3 fs-4">
                        <a target="_blank" href="https://www.facebook.com/DirtyCoins.VN" class="text-white"><i class="bi bi-facebook"></i></a>
                        <a target="_blank" href="https://www.instagram.com/dirtycoins.vn/?hl=vi" class="text-white"><i class="bi bi-instagram"></i></a>
                        <a target="_blank" href="https://www.tiktok.com/@@dirtycoins.vn" class="text-white"><i class="bi bi-tiktok"></i></a>
                        <a target="_blank" href="https://www.youtube.com/@@dirtycoins.official" class="text-white"><i class="bi bi-youtube"></i></a>
                    </div>
                </div>
            </div>

            <div class="footer-bottom text-center mt-4 pt-3">
                &copy; 2025 <strong>DirtyCoins</strong> — Streetwear & Lifestyle.
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.0/signalr.min.js"></script>

    <script>
        const connection = new signalR.HubConnectionBuilder().withUrl("/systemHub").build();

        function showToast(message) {
            const toast = document.createElement("div");
            toast.className = "maintenance-toast";
            toast.innerHTML = `<i class="bi bi-tools me-2 text-warning"></i>${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 8000);
        }

        connection.on("MaintenanceAlert", (data) => {
            const msg = data.IsImportant
                ? `🚨 <b>Bảo trì quan trọng!</b><br>${data.Reason}`
                : `⚙️ ${data.Reason}`;
            showToast(msg);
        });

        connection.on("ForceMaintenance", (data) => {
            const msg = data.Message || "Hệ thống sẽ tạm dừng để bảo trì.";
            showToast(`${msg}<br>Chuyển hướng trong ${data.RedirectAfter || 5} giây...`);
            setTimeout(() => { window.location.href = "/Maintenance"; }, (data.RedirectAfter || 5) * 1000);
        });

        connection.start().catch(err => console.error(err));

        // Navbar scroll effect
        window.addEventListener("scroll", () => {
            const header = document.getElementById("mainHeader");
            if (window.scrollY > 60) {
                header.classList.add("scrolled");
            } else {
                header.classList.remove("scrolled");
            }
        });
        // 🎯 Khi cuộn xuống → thêm class .scrolled cho navbar
        document.addEventListener("scroll", function () {
            const navbar = document.querySelector(".navbar-dc");
            if (window.scrollY > 100) {
                navbar.classList.add("scrolled");
            } else {
                navbar.classList.remove("scrolled");
            }
        });
    </script>

    @RenderSection("Scripts", required: false)
</body>
</html>
